<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LUCKY Delivery</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#FFA726">
  <link rel="apple-touch-icon" href="icon-192x192.png">
  <link rel="stylesheet" href="style.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script type="module">
    import { liffId } from './config.js';
    window.showLiffErrorPopup = function(msg, err) {
      let popup = document.getElementById('liffErrorPopup');
      if (popup) popup.remove();
      popup = document.createElement('div');
      popup.id = 'liffErrorPopup';
      popup.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:99999;display:flex;align-items:center;justify-content:center;';
      let detail = '';
      if (err) {
        detail = `<div style='color:#b71c1c;font-size:0.98em;margin-top:0.7em;word-break:break-all;'>${err.message || err.toString()}</div>`;
      }
      popup.innerHTML = `
        <div style="background:#fff;padding:2em 2.5em;border-radius:14px;box-shadow:0 2px 16px #d32f2f55;text-align:center;max-width:90vw;">
          <div style="font-size:1.25em;font-weight:700;color:#d32f2f;margin-bottom:1em;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LINE Login</div>
          <div style="color:#444;margin-bottom:1.5em;">${msg}</div>
          ${detail}
          <button onclick="document.getElementById('liffErrorPopup').remove()" style="background:#d32f2f;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;">‡∏õ‡∏¥‡∏î</button>
        </div>
      `;
      document.body.appendChild(popup);
    };

    async function ensureLiffLogin() {
      try {
        await liff.init({ liffId });
        if (!liff.isLoggedIn()) {
          // Show login overlay
          let overlay = document.getElementById('loginOverlay');
          if (!overlay) {
            overlay = document.createElement('div');
            overlay.id = 'loginOverlay';
            overlay.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(255,255,255,0.95);z-index:99999;display:flex;flex-direction:column;align-items:center;justify-content:center;';
            overlay.innerHTML = `<div style='font-size:1.3em;font-weight:700;margin-bottom:1.5em;'>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢ LINE ‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</div><button id='liffLoginBtn' style='background:#FFA726;color:#fff;padding:1em 2.5em;border:none;border-radius:10px;font-size:1.1em;font-weight:700;cursor:pointer;'>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö LINE</button>`;
            document.body.appendChild(overlay);
            document.getElementById('liffLoginBtn').onclick = () => liff.login();
          }
          return false;
        } else {
          // Remove overlay if exists
          let overlay = document.getElementById('loginOverlay');
          if (overlay) overlay.remove();
          return true;
        }
      } catch (err) {
        window.showLiffErrorPopup('LIFF initialization failed.', err);
        return false;
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await ensureLiffLogin();
    });
  </script>
</head>
<body>
  <header style="position:relative;">
    <nav class="stepper">
      <div class="step active"><span>1</span><div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div></div>
      <div class="step"><span>2</span><div>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div></div>
      <div class="step"><span>3</span><div>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div></div>
      <div class="step"><span>4</span><div>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div></div>
    </nav>
    <div id="lineProfileBox" style="display:none;position:absolute;top:0.7em;right:1.2em;text-align:right;z-index:20;"></div>
  </header>
  <div id="error"></div>
  <main class="container">
    <h1>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
    <section class="product-catalog">
      <form id="productForm">
        <div class="product-list" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.2em;">
          <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
        <div class="cart-summary">
          <span id="totalPrice">‡∏£‡∏ß‡∏°: ‡∏ø0</span>
          <button type="submit" class="btn-main">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </form>
      <div id="cartNotice" class="cart-notice"></div>
    </section>
  </main>
  <footer>
    LUCKY Delivery &copy; 2024
  </footer>
  <script src="order.js"></script>
  <script>
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ order.js ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ renderProducts ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!document.querySelector('.product-list').children.length) {
      document.querySelector('.product-list').innerHTML = '<div style="color:#d32f2f;text-align:center;padding:2em 0;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</div>';
    }
    // Register service worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js')
        .then(registration => console.log('Service Worker registered with scope:', registration.scope))
        .catch(error => console.error('Service Worker registration failed:', error));
    }
  </script>
  <script>
    getLocationBtn.onclick = function(e) {
      e.preventDefault();
      if (!navigator.geolocation) {
        showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
        return;
      }
      getLocationBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
      getLocationBtn.disabled = true;
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        mapPreview.innerHTML = `<div style="color:#FFA726;">‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(5)}, ${lng.toFixed(5)}</div>`;
        addressInput.value = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 1800);
        getLocationBtn.textContent = 'üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà';
        getLocationBtn.disabled = false;
      }, err => {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ');
        getLocationBtn.textContent = 'üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà';
        getLocationBtn.disabled = false;
      });
    };
  </script>
</body>
</html>
