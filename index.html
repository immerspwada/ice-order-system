<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ - LUCKY Delivery</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
function showLiffErrorPopup(msg, err) {
  let popup = document.getElementById('liffErrorPopup');
  if (popup) popup.remove();
  popup = document.createElement('div');
  popup.id = 'liffErrorPopup';
  popup.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:99999;display:flex;align-items:center;justify-content:center;';
  let detail = '';
  if (err) {
    detail = `<div style='color:#b71c1c;font-size:0.98em;margin-top:0.7em;word-break:break-all;'>${err.message || err.toString()}</div>`;
  }
  popup.innerHTML = `
    <div style="background:#fff;padding:2em 2.5em;border-radius:14px;box-shadow:0 2px 16px #d32f2f55;text-align:center;max-width:90vw;">
      <div style="font-size:1.25em;font-weight:700;color:#d32f2f;margin-bottom:1em;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î LINE Login</div>
      <div style="color:#444;margin-bottom:1.5em;">${msg}</div>
      ${detail}
      <button onclick="document.getElementById('liffErrorPopup').remove()" style="background:#d32f2f;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;">‡∏õ‡∏¥‡∏î</button>
    </div>
  `;
  document.body.appendChild(popup);
}

async function initializeLiffSession(liffId) {
  try {
    await liff.init({ liffId });
    if (!liff.isLoggedIn()) {
      const url = new URL(window.location.href);
      if (!url.searchParams.has('liff.state')) {
        liff.login({ redirectUri: window.location.href });
        return null;
      } else {
        console.warn('[LIFF] Login failed or cancelled.');
        showLiffErrorPopup('LINE Login was cancelled or failed.');
        return null;
      }
    }
    let profile, idToken;
    try {
      profile = await liff.getProfile();
      idToken = liff.getIDToken();
    } catch (profileErr) {
      console.error('[LIFF] Failed to get profile:', profileErr);
      showLiffErrorPopup('Failed to fetch LINE profile.', profileErr);
      return null;
    }
    const userData = {
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl,
      lineUserId: profile.userId,
      idToken: idToken
    };
    for (const [k, v] of Object.entries(userData)) {
      localStorage.setItem(k, v);
      sessionStorage.setItem(k, v);
    }
    console.log('[LIFF] User loaded:', userData);
    return userData;
  } catch (err) {
    console.error('[LIFF] Initialization error:', err);
    showLiffErrorPopup('LIFF initialization failed.', err);
    return null;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initializeLiffSession('2006986568-yjrOkKqm');
});
  </script>
</head>
<body>
  <header style="position:relative;">
    <nav class="stepper">
      <div class="step active"><span>1</span><div>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</div></div>
      <div class="step"><span>2</span><div>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤</div></div>
      <div class="step"><span>3</span><div>‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</div></div>
      <div class="step"><span>4</span><div>‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô</div></div>
    </nav>
    <div id="lineProfileBox" style="display:none;position:absolute;top:0.7em;right:1.2em;text-align:right;z-index:20;"></div>
  </header>
  <main class="container">
    <h1>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</h1>
    <section class="product-catalog">
      <form id="productForm">
        <div class="product-list" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.2em;">
          <!-- ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å render ‡∏î‡πâ‡∏ß‡∏¢ JS -->
        </div>
        <div class="cart-summary">
          <span id="totalPrice">‡∏£‡∏ß‡∏°: ‡∏ø0</span>
          <button type="submit" class="btn-main">‡∏ñ‡∏±‡∏î‡πÑ‡∏õ</button>
        </div>
      </form>
      <div id="cartNotice" class="cart-notice"></div>
    </section>
  </main>
  <script src="order.js"></script>
  <script>
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ order.js ‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞ renderProducts ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    if (!document.querySelector('.product-list').children.length) {
      document.querySelector('.product-list').innerHTML = '<div style="color:#d32f2f;text-align:center;padding:2em 0;">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö</div>';
    }
  </script>
  <script>
    getLocationBtn.onclick = function(e) {
      e.preventDefault();
      if (!navigator.geolocation) {
        showToast('‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á');
        return;
      }
      getLocationBtn.textContent = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á...';
      getLocationBtn.disabled = true;
      navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;
        mapPreview.innerHTML = `<div style="color:#FFA726;">‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(5)}, ${lng.toFixed(5)}</div>`;
        addressInput.value = `‡∏û‡∏¥‡∏Å‡∏±‡∏î: ${lat.toFixed(5)}, ${lng.toFixed(5)}`;
        showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 1800);
        getLocationBtn.textContent = 'üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà';
        getLocationBtn.disabled = false;
      }, err => {
        showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ');
        getLocationBtn.textContent = 'üìç ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏à‡∏≤‡∏Å‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà';
        getLocationBtn.disabled = false;
      });
    };
  </script>
</body>
</html>
