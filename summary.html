<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>สั่งซื้อ LUCKY - สรุปคำสั่งซื้อ</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
/**
 * Robust LIFF authentication/session handler for static hosting (GitHub Pages)
 * Usage: await initializeLiffSession('YOUR_LIFF_ID');
 * Access user: getStoredLiffUser()
 */
async function initializeLiffSession(liffId) {
  try {
    await liff.init({ liffId });
    if (!liff.isLoggedIn()) {
      // Prevent infinite redirect loop by checking liff.state in URL
      const url = new URL(window.location.href);
      if (!url.searchParams.has('liff.state')) {
        liff.login({ redirectUri: window.location.href });
        return null;
      } else {
        console.warn('[LIFF] Login failed or cancelled.');
        showLiffError('LINE Login was cancelled or failed.');
        return null;
      }
    }
    // Already logged in
    let profile, idToken;
    try {
      profile = await liff.getProfile();
      idToken = liff.getIDToken();
    } catch (profileErr) {
      console.error('[LIFF] Failed to get profile:', profileErr);
      showLiffError('Failed to fetch LINE profile.');
      return null;
    }
    const userData = {
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl,
      lineUserId: profile.userId,
      idToken: idToken
    };
    for (const [k, v] of Object.entries(userData)) {
      localStorage.setItem(k, v);
      sessionStorage.setItem(k, v);
    }
    console.log('[LIFF] User loaded:', userData);
    return userData;
  } catch (err) {
    console.error('[LIFF] Initialization error:', err);
    showLiffError('LIFF initialization failed.');
    return null;
  }
}

function getStoredLiffUser() {
  const keys = ['displayName', 'pictureUrl', 'lineUserId', 'idToken'];
  const user = {};
  for (const k of keys) {
    user[k] = sessionStorage.getItem(k) || localStorage.getItem(k) || '';
  }
  if (!user.displayName || !user.lineUserId) return null;
  return user;
}

function showLiffError(msg) {
  // Try toast, fallback to alert
  let toast = document.querySelector('.toast');
  if (!toast) {
    toast = document.createElement('div');
    toast.className = 'toast';
    toast.style = 'position:fixed;top:1.5em;left:50%;transform:translateX(-50%);background:#d32f2f;color:#fff;padding:1em 2em;border-radius:8px;z-index:9999;font-weight:600;box-shadow:0 2px 8px #d32f2f55;';
    document.body.appendChild(toast);
  }
  toast.textContent = msg;
  toast.classList.add('show');
  setTimeout(()=>toast.classList.remove('show'), 3500);
  // Fallback
  if (!toast) alert(msg);
}

document.addEventListener('DOMContentLoaded', () => {
  initializeLiffSession('U56b89fa4ea4169863a687fe972fa3836');
});
  </script>
</head>
<body>
  <header>
    <nav class="stepper">
      <div class="step"><span>1</span><div>เลือกสินค้า</div></div>
      <div class="step"><span>2</span><div>ข้อมูลลูกค้า</div></div>
      <div class="step active"><span>3</span><div>ยืนยัน</div></div>
      <div class="step"><span>4</span><div>เสร็จสิ้น</div></div>
    </nav>
  </header>
  <div id="orderSummary"></div>
  <script src="summary.js"></script>
</body>
</html>
