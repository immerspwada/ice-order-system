<!-- หน้าใบเสร็จ -->
<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>สั่งซื้อ LUCKY - ใบเสร็จ</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  <script src="html2pdf.bundle.min.js"></script>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <script>
function showLiffErrorPopup(msg) {
  // Remove existing popup if any
  let popup = document.getElementById('liffErrorPopup');
  if (popup) popup.remove();
  popup = document.createElement('div');
  popup.id = 'liffErrorPopup';
  popup.style = 'position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.45);z-index:99999;display:flex;align-items:center;justify-content:center;';
  popup.innerHTML = `
    <div style="background:#fff;padding:2em 2.5em;border-radius:14px;box-shadow:0 2px 16px #d32f2f55;text-align:center;max-width:90vw;">
      <div style="font-size:1.25em;font-weight:700;color:#d32f2f;margin-bottom:1em;">เกิดข้อผิดพลาดในการโหลด LINE Login</div>
      <div style="color:#444;margin-bottom:1.5em;">${msg}</div>
      <button onclick="document.getElementById('liffErrorPopup').remove()" style="background:#d32f2f;color:#fff;padding:0.7em 2em;border:none;border-radius:8px;font-size:1em;font-weight:600;cursor:pointer;">ปิด</button>
    </div>
  `;
  document.body.appendChild(popup);
}

async function initializeLiffSession(liffId) {
  try {
    await liff.init({ liffId });
    if (!liff.isLoggedIn()) {
      const url = new URL(window.location.href);
      if (!url.searchParams.has('liff.state')) {
        liff.login({ redirectUri: window.location.href });
        return null;
      } else {
        console.warn('[LIFF] Login failed or cancelled.');
        showLiffErrorPopup('LINE Login was cancelled or failed.');
        return null;
      }
    }
    let profile, idToken;
    try {
      profile = await liff.getProfile();
      idToken = liff.getIDToken();
    } catch (profileErr) {
      console.error('[LIFF] Failed to get profile:', profileErr);
      showLiffErrorPopup('Failed to fetch LINE profile.');
      return null;
    }
    const userData = {
      displayName: profile.displayName,
      pictureUrl: profile.pictureUrl,
      lineUserId: profile.userId,
      idToken: idToken
    };
    for (const [k, v] of Object.entries(userData)) {
      localStorage.setItem(k, v);
      sessionStorage.setItem(k, v);
    }
    console.log('[LIFF] User loaded:', userData);
    return userData;
  } catch (err) {
    console.error('[LIFF] Initialization error:', err);
    showLiffErrorPopup('LIFF initialization failed.\n' + (err && err.message ? err.message : ''));
    return null;
  }
}

document.addEventListener('DOMContentLoaded', () => {
  initializeLiffSession('U56b89fa4ea4169863a687fe972fa3836');
});
  </script>
</head>
<body>
  <header>
    <nav class="stepper">
      <div class="step"><span>1</span><div>เลือกสินค้า</div></div>
      <div class="step"><span>2</span><div>ข้อมูลลูกค้า</div></div>
      <div class="step"><span>3</span><div>ยืนยัน</div></div>
      <div class="step active"><span>4</span><div>เสร็จสิ้น</div></div>
    </nav>
  </header>
  <div id="receipt">
    <!-- Receipt content will be rendered here by receipt.js -->
    <div style="text-align:center;margin-top:1.5rem;">
      <button id="downloadPdfBtn" style="background:linear-gradient(90deg,#FFD700 0%,#FFF8DC 100%);color:#181818;padding:1.1rem 2.2rem;border:none;border-radius:12px;font-size:1.13rem;font-weight:700;box-shadow:0 2px 12px #fffbe7;transition:background 0.2s, color 0.2s;letter-spacing:0.5px;border:1.5px solid #fff8dc;">ดาวน์โหลดใบเสร็จ (PDF)</button>
    </div>
  </div>
  <script src="receipt.js"></script>
  <script>
    // --- PDF Button State Management ---
    const pdfBtn = document.getElementById('downloadPdfBtn');
    let originalBtnText = pdfBtn.textContent;
    pdfBtn.disabled = false;
    pdfBtn.style.opacity = '1';
    pdfBtn.style.cursor = 'pointer';
    pdfBtn.onclick = function() {
      if (typeof window.html2pdf === 'undefined') {
        alert('ไม่สามารถดาวน์โหลด PDF ได้\nกรุณาตรวจสอบว่าไฟล์ html2pdf.bundle.min.js อยู่ในโฟลเดอร์เดียวกับ receipt.html');
        return;
      }
      pdfBtn.disabled = true;
      pdfBtn.textContent = 'กำลังสร้าง PDF...';
      window.html2pdf().from(document.getElementById('receipt')).set({
        margin: 10,
        filename: 'receipt.pdf',
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      }).save().finally(() => {
        pdfBtn.disabled = false;
        pdfBtn.textContent = originalBtnText;
      });
    };
  </script>
</body>
</html>
